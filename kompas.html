<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-VOTING FORDA PASURUAN | PROFESSIONAL SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .hidden-section {
            display: none !important;
        }
        
        .bg-royal-red {
            background: linear-gradient(135deg, #450a0a 0%, #991b1b 100%);
        }
        
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 font-sans">

    <div class="fixed top-0 left-0 w-full z-[100] bg-white border-b px-6 py-2 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-4 text-[10px] font-black uppercase tracking-widest">
            <span class="flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Server Active</span>
            <span class="text-slate-300">|</span>
            <span id="liveClock">00:00:00</span>
        </div>
        <div class="bg-red-600 text-white px-3 py-1 rounded-full text-[9px] font-black uppercase">
            <span id="voterCountTop">0</span> Suara Masuk
        </div>
    </div>

    <div id="loginOverlay" class="fixed inset-0 z-[150] bg-royal-red flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl max-w-md w-full text-center relative overflow-hidden animate-fade">
            <div class="absolute top-0 left-0 w-full h-2 bg-red-600"></div>
            <h1 class="text-3xl font-black text-slate-900 mb-2 italic">FORDA.<span class="text-red-600 uppercase">Pas</span></h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em] mb-8">Leadership Election 2025</p>

            <div class="space-y-4 text-left">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Identitas Pemilih</label>
                    <input type="text" id="vName" placeholder="Nama Lengkap Anda" class="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-red-600 rounded-2xl outline-none font-bold transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">NIM</label>
                    <input type="text" id="vInfo" placeholder="NIM" class="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-red-600 rounded-2xl outline-none font-bold transition-all">
                </div>
                <button onclick="handleEntry()" class="w-full bg-red-600 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-red-700 transition-all uppercase tracking-widest text-xs">Masuk Bilik Suara</button>
            </div>
            <p id="timerWarning" class="mt-6 text-[10px] font-bold text-red-500 uppercase tracking-tighter"></p>
        </div>
    </div>

    <div id="mainContent" class="hidden-section pt-16">
        <header class="bg-white/80 backdrop-blur-md p-6 text-center border-b sticky top-10 z-[50]">
            <h2 class="text-xl font-black text-slate-900 italic uppercase">Tentukan Masa Depan Organisasi</h2>
            <div id="userBadge" class="mt-2 text-[9px] font-bold text-red-600 uppercase tracking-widest"></div>
        </header>

        <main class="py-12 container mx-auto px-4 max-w-6xl">
            <div id="candidateGrid" class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-20"></div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div id="chartSection" class="lg:col-span-2 bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 hidden-section">
                    <h3 class="font-black text-slate-900 mb-8 uppercase italic flex items-center gap-2">
                        <i class="fas fa-chart-bar text-red-600"></i> Statistik Perolehan Sementara
                    </h3>
                    <div style="height: 350px;"><canvas id="voteChart"></canvas></div>
                </div>
                <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 flex flex-col">
                    <h3 class="font-black text-slate-900 mb-6 uppercase italic text-sm">
                        <i class="fas fa-history text-red-600 mr-2"></i> Aktivitas Terakhir
                    </h3>
                    <div id="recentActivity" class="space-y-4 flex-grow"></div>
                    <div class="mt-6 p-4 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Sistem Audit</p>
                        <p class="text-[10px] font-black text-slate-700 mt-1">Data terenkripsi dan diverifikasi oleh IP Address unik pemilih.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="adminPanel" class="fixed inset-0 z-[200] bg-slate-50 hidden-section p-6 overflow-y-auto">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-10 border-b pb-6">
                <div>
                    <h2 class="text-2xl font-black text-red-900 italic uppercase">Admin Command Center</h2>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Manajemen Suara & Konten</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadCSV()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-lg shadow-emerald-100">Export CSV</button>
                    <button onclick="toggleAdmin()" class="bg-white text-slate-900 w-10 h-10 rounded-full flex items-center justify-center shadow-lg border hover:bg-red-600 hover:text-white transition"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                <div class="p-6 bg-white rounded-3xl shadow-sm border border-slate-100">
                    <h4 class="font-black text-[10px] uppercase text-red-600 mb-4 tracking-widest">Set Durasi Voting (Menit)</h4>
                    <div class="flex gap-2">
                        <input type="number" id="adminTimerInput" placeholder="Contoh: 60" class="flex-grow p-3 bg-slate-50 rounded-xl outline-none font-bold">
                        <button onclick="setTimer()" class="bg-red-600 text-white px-6 py-3 rounded-xl text-[10px] font-black uppercase">Aktifkan</button>
                    </div>
                </div>
                <div class="p-6 bg-white rounded-3xl shadow-sm border border-slate-100 flex items-center justify-between">
                    <div>
                        <h4 class="font-black text-[10px] uppercase text-slate-900 tracking-widest">Visibilitas Live Count</h4>
                        <p class="text-[9px] text-slate-400 font-bold italic mt-1">Sembunyikan angka selama pemilihan berlangsung</p>
                    </div>
                    <button id="chartToggler" onclick="toggleChart()" class="w-14 h-7 bg-slate-200 rounded-full p-1 transition-all"><div id="dotToggler" class="w-5 h-5 bg-white rounded-full transition-all"></div></button>
                </div>
            </div>

            <div id="adminCandidateEdit" class="space-y-4 mb-10"></div>

            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                <h4 class="font-black text-[10px] uppercase text-slate-400 mb-6 tracking-widest border-b pb-2">Audit Traceability (Log Seluruh Pemilih)</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-[11px] font-bold">
                        <thead>
                            <tr class="text-slate-400 border-b">
                                <th class="p-3">WAKTU</th>
                                <th class="p-3">NAMA PEMILIH</th>
                                <th class="p-3">PILIHAN</th>
                                <th class="p-3">IP DEVICE</th>
                                <th class="p-3 text-center">AKSI</th>
                            </tr>
                        </thead>
                        <tbody id="auditTable"></tbody>
                    </table>
                </div>
            </div>

            <button onclick="factoryReset()" class="mt-10 w-full p-4 border-2 border-red-50 text-red-100 hover:text-red-600 transition rounded-[2rem] font-black uppercase text-[10px] tracking-[0.3em]">Factory Reset System</button>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 z-[250]">
        <button onclick="toggleAdmin()" class="w-12 h-12 bg-slate-900 text-white rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 transition-all border border-white/20">
            <i class="fas fa-cog"></i>
        </button>
    </div>

    <script>
        let ip = "0.0.0.0";
        fetch('https://api.ipify.org?format=json').then(r => r.json()).then(d => {
            ip = d.ip;
        }).catch(e => console.log("IP fetch failed"));

        // CLOCK
        setInterval(() => {
            document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('id-ID');
        }, 1000);

        const defData = [{
            id: 0,
            nama: "Ahmad Zaki",
            visi: "Mewujudkan pemuda Pasuruan yang inovatif.",
            foto: "https://via.placeholder.com/400x500?text=Kandidat+01",
            suara: 0
        }, {
            id: 1,
            nama: "Siti Aminah",
            visi: "Sinergi kolaborasi pemuda Pasuruan.",
            foto: "https://via.placeholder.com/400x500?text=Kandidat+02",
            suara: 0
        }, {
            id: 2,
            nama: "Bambang Heru",
            visi: "Membangun Forda yang transparan.",
            foto: "https://via.placeholder.com/400x500?text=Kandidat+03",
            suara: 0
        }];

        let candidates = JSON.parse(localStorage.getItem('frd_v3_data')) || defData;
        let logs = JSON.parse(localStorage.getItem('frd_v3_logs')) || [];
        let config = JSON.parse(localStorage.getItem('frd_v3_cfg')) || {
            showChart: false,
            expiry: 0
        };
        let voteChart;

        function handleEntry() {
            const name = document.getElementById('vName').value.trim();
            const info = document.getElementById('vInfo').value.trim();
            if (!name || !info) return alert("Harap lengkapi identitas Anda!");
            if (localStorage.getItem('voted_' + name.toLowerCase())) return alert("Nama ini sudah tercatat memberikan suara!");
            if (logs.find(l => l.ip === ip && ip !== "0.0.0.0")) return alert("Satu perangkat hanya diperbolehkan satu kali suara!");

            document.getElementById('loginOverlay').classList.add('hidden-section');
            document.getElementById('mainContent').classList.remove('hidden-section');
            document.getElementById('userBadge').innerText = `${name.toUpperCase()} | ${info.toUpperCase()} | VERIFIED`;
            document.getElementById('voterCountTop').innerText = logs.length;

            if (config.showChart) {
                document.getElementById('chartSection').classList.remove('hidden-section');
            }

            renderCandidates();
            updateActivity();
            initChart();
        }

        function renderCandidates() {
            document.getElementById('candidateGrid').innerHTML = candidates.map((k, i) => `
                <div class="bg-white rounded-[3rem] shadow-xl overflow-hidden border border-slate-100 flex flex-col group animate-fade">
                    <div class="h-80 overflow-hidden relative">
                        <img src="${k.foto}" class="w-full h-full object-cover group-hover:scale-110 transition duration-700">
                        <div class="absolute inset-0 bg-gradient-to-t from-red-950 to-transparent opacity-60"></div>
                        <div class="absolute bottom-6 left-8 text-left">
                            <h4 class="text-2xl font-black text-white italic uppercase">${k.nama}</h4>
                            <p class="text-[9px] font-black text-red-400 tracking-widest uppercase mt-1">Nomor Urut 0${i+1}</p>
                        </div>
                    </div>
                    <div class="p-8 text-center flex-grow flex flex-col">
                        <p class="text-slate-500 text-xs font-bold leading-relaxed mb-8 flex-grow">"${k.visi}"</p>
                        <button onclick="castVote(${i})" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl hover:bg-red-600 transition shadow-xl uppercase tracking-widest text-[10px]">Berikan Suara</button>
                    </div>
                </div>`).join('');
        }

        function castVote(idx) {
            const name = document.getElementById('vName').value;
            if (confirm(`Apakah Anda yakin ingin memberikan mandat kepada ${candidates[idx].nama}?`)) {
                candidates[idx].suara++;
                logs.push({
                    id: Date.now(),
                    time: new Date().toLocaleTimeString('id-ID'),
                    name: name,
                    ip: ip,
                    pNama: candidates[idx].nama,
                    pIdx: idx
                });

                localStorage.setItem('frd_v3_data', JSON.stringify(candidates));
                localStorage.setItem('frd_v3_logs', JSON.stringify(logs));
                localStorage.setItem('voted_' + name.toLowerCase(), 'true');

                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: {
                        y: 0.6
                    },
                    colors: ['#991b1b', '#000000']
                });
                alert("SUARA ANDA SAH!");
                location.reload();
            }
        }

        function toggleAdmin() {
            const panel = document.getElementById('adminPanel');
            if (panel.classList.contains('hidden-section')) {
                const pass = prompt("PASSWORD ADMIN:");
                if (pass === "forda123") {
                    panel.classList.remove('hidden-section');
                    renderAdminView();
                    renderLogs();
                    updateAdminUI();
                } else if (pass !== null) {
                    alert("Password Salah!");
                }
            } else {
                panel.classList.add('hidden-section');
            }
        }

        function renderAdminView() {
            document.getElementById('adminCandidateEdit').innerHTML = candidates.map((k, i) => `
                <div class="p-6 bg-white rounded-3xl shadow-sm border border-slate-100 flex flex-wrap items-center gap-6 text-left">
                    <img src="${k.foto}" id="pre${i}" class="w-14 h-14 rounded-2xl object-cover shadow-md">
                    <div class="flex-grow space-y-2">
                        <input type="text" value="${k.nama}" onchange="upK(${i}, 'nama', this.value)" class="w-full p-2 bg-slate-50 border-none rounded-xl text-xs font-black uppercase">
                        <input type="text" value="${k.visi}" onchange="upK(${i}, 'visi', this.value)" class="w-full p-2 bg-slate-50 border-none rounded-xl text-xs italic">
                        <button onclick="document.getElementById('f${i}').click()" class="text-[7px] font-black text-red-600 uppercase">Ganti Foto Kandidat</button>
                        <input type="file" id="f${i}" class="hidden" onchange="upImg(event, ${i})">
                    </div>
                    <div class="bg-red-800 text-white p-4 rounded-3xl min-w-[80px] text-center shadow-lg shadow-red-100">
                        <p class="text-[10px] font-black">${k.suara}</p>
                        <p class="text-[7px] uppercase font-bold opacity-60">Votes</p>
                    </div>
                </div>`).join('');
        }

        function renderLogs() {
            document.getElementById('auditTable').innerHTML = logs.map(l => `
                <tr class="border-b border-slate-50 hover:bg-red-50 transition">
                    <td class="p-4 text-slate-300 font-mono text-[9px] uppercase">${l.time}</td>
                    <td class="p-4 font-black text-left">${l.name}</td>
                    <td class="p-4 text-red-600 italic font-black uppercase text-left">${l.pNama}</td>
                    <td class="p-4 text-slate-400 font-mono text-[9px] text-left">${l.ip}</td>
                    <td class="p-4 text-center">
                        <button onclick="removeV(${l.id})" class="text-red-300 hover:text-red-600 transition"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).reverse().join('');
        }

        function updateActivity() {
            const activityHtml = logs.slice(-5).map(l => `
                <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-100 text-left">
                    <div class="w-2 h-2 bg-red-600 rounded-full"></div>
                    <div>
                        <p class="text-[10px] font-black uppercase">${l.name}</p>
                        <p class="text-[8px] text-slate-400 font-bold uppercase tracking-widest">${l.time} - Verified</p>
                    </div>
                </div>`).reverse().join('');
            document.getElementById('recentActivity').innerHTML = activityHtml || '<p class="text-center text-slate-300 text-xs py-10 font-black uppercase text-center">Belum ada suara</p>';
        }

        function upK(i, k, v) {
            candidates[i][k] = v;
            localStorage.setItem('frd_v3_data', JSON.stringify(candidates));
        }

        function upImg(e, i) {
            const r = new FileReader();
            r.onload = (ev) => {
                candidates[i].foto = ev.target.result;
                document.getElementById('pre' + i).src = ev.target.result;
                localStorage.setItem('frd_v3_data', JSON.stringify(candidates));
            };
            r.readAsDataURL(e.target.files[0]);
        }

        function removeV(id) {
            const idx = logs.findIndex(l => l.id === id);
            if (idx > -1 && confirm("Batalkan suara pemilih ini secara permanen?")) {
                candidates[logs[idx].pIdx].suara--;
                localStorage.removeItem('voted_' + logs[idx].name.toLowerCase());
                logs.splice(idx, 1);
                localStorage.setItem('frd_v3_data', JSON.stringify(candidates));
                localStorage.setItem('frd_v3_logs', JSON.stringify(logs));
                renderLogs();
                renderAdminView();
                alert("Data berhasil dihapus!");
            }
        }

        function toggleChart() {
            config.showChart = !config.showChart;
            localStorage.setItem('frd_v3_cfg', JSON.stringify(config));
            updateAdminUI();
            alert("Setting grafik diperbarui!");
        }

        function updateAdminUI() {
            const btn = document.getElementById('chartToggler');
            const dot = document.getElementById('dotToggler');
            btn.classList.toggle('bg-red-600', config.showChart);
            btn.classList.toggle('bg-slate-200', !config.showChart);
            dot.style.marginLeft = config.showChart ? '28px' : '0px';
        }

        function setTimer() {
            const m = document.getElementById('adminTimerInput').value;
            if (!m) return alert("Isi angka menit!");
            config.expiry = new Date().getTime() + (parseInt(m) * 60000);
            localStorage.setItem('frd_v3_cfg', JSON.stringify(config));
            alert("Timer Berhasil Diaktifkan!");
        }

        function initChart() {
            const ctx = document.getElementById('voteChart').getContext('2d');
            if (voteChart) voteChart.destroy();
            voteChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: candidates.map(k => k.nama),
                    datasets: [{
                        data: candidates.map(k => k.suara),
                        backgroundColor: '#991b1b',
                        borderRadius: 20,
                        barThickness: 50
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            display: false
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function downloadCSV() {
            let csv = "Waktu,Nama,Pilihan,IP\n" + logs.map(l => `${l.time},${l.name},${l.pNama},${l.ip}`).join("\n");
            let a = document.createElement('a');
            a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            a.download = 'Laporan_Audit_Voting.csv';
            a.click();
        }

        function factoryReset() {
            if (confirm("PERINGATAN: Hapus total seluruh data?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // TIMER INTERVAL
        setInterval(() => {
            if (config.expiry > 0) {
                const dist = config.expiry - new Date().getTime();
                const timerEl = document.getElementById('timerWarning');
                if (dist < 0) {
                    timerEl.innerText = "VOTING TELAH BERAKHIR";
                    document.getElementById('loginOverlay').innerHTML = "<div class='text-center py-20 font-black text-red-600 text-2xl uppercase tracking-widest animate-pulse'>Voting Closed</div>";
                } else {
                    const m = Math.floor((dist % 3600000) / 60000);
                    const s = Math.floor((dist % 60000) / 1000);
                    timerEl.innerText = `TUTUP DALAM: ${m}m ${s}s`;
                }
            }
        }, 1000);
    </script>
</body>

</html>